<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>äº‘ç«¯åŒæ­¥æµ‹è¯•</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
    .test-block { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; border: 2px solid #ddd; }
    .success { border-color: #10B981; background: #ecfdf5; }
    .error { border-color: #ef4444; background: #fef2f2; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #3b82f6; color: white; border: none; border-radius: 4px; }
    .log { background: #1e293b; color: #10b981; padding: 15px; border-radius: 4px; margin-top: 10px; font-size: 12px; max-height: 400px; overflow-y: auto; }
    .log-entry { margin: 5px 0; }
    .log-error { color: #ef4444; }
    .log-info { color: #3b82f6; }
    input { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; width: 300px; }
  </style>
</head>
<body>
  <h1>ğŸ§ª äº‘ç«¯åŒæ­¥åŠŸèƒ½æµ‹è¯•</h1>

  <div class="test-block">
    <h2>ğŸ“± è®¾å¤‡ä¿¡æ¯</h2>
    <p><strong>å½“å‰è®¾å¤‡ ID:</strong> <span id="device-id">åŠ è½½ä¸­...</span></p>
    <button onclick="copyDeviceId()">ğŸ“‹ å¤åˆ¶è®¾å¤‡ ID</button>
    <button onclick="regenerateDeviceId()">ğŸ”„ é‡æ–°ç”Ÿæˆè®¾å¤‡ ID</button>
    <br><br>
    <label>è®¾ç½®è‡ªå®šä¹‰è®¾å¤‡ ID (ç”¨äºè·¨è®¾å¤‡æµ‹è¯•):</label><br>
    <input type="text" id="custom-device-id" placeholder="è¾“å…¥å¦ä¸€å°è®¾å¤‡çš„ ID">
    <button onclick="setCustomDeviceId()">âœ… è®¾ç½®å¹¶åˆ·æ–°</button>
  </div>

  <div class="test-block">
    <h2>â˜ï¸ äº‘ç«¯åŒæ­¥æµ‹è¯•</h2>
    <h3>æµ‹è¯•æ•°æ®:</h3>
    <textarea id="test-data" rows="8" style="width: 100%; font-family: monospace;">
{
  "platform-presets": {
    "custom": [
      {
        "id": "test-123",
        "name": "æµ‹è¯•å¹³å°",
        "url": "https://api.test.com"
      }
    ],
    "builtInOverrides": {}
  },
  "api-urls": ["https://api.openai.com"],
  "api-keys": ["sk-test-key-123"]
}
    </textarea>
    <br>
    <button onclick="uploadTest()">â¬†ï¸ ä¸Šä¼ åˆ°äº‘ç«¯</button>
    <button onclick="downloadTest()">â¬‡ï¸ ä»äº‘ç«¯ä¸‹è½½</button>
    <button onclick="clearTest()">ğŸ—‘ï¸ æ¸…é™¤äº‘ç«¯æ•°æ®</button>
  </div>

  <div class="test-block">
    <h2>ğŸ” KV å­˜å‚¨æ£€æŸ¥</h2>
    <button onclick="checkKVStorage()">æ£€æŸ¥ KV ä¸­çš„æ•°æ®</button>
    <button onclick="listAllKeys()">åˆ—å‡ºæ‰€æœ‰ Keys</button>
  </div>

  <div class="test-block">
    <h2>ğŸ“‹ æ“ä½œæ—¥å¿—</h2>
    <button onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
    <div id="log" class="log"></div>
  </div>

  <script>
    const API_ENDPOINT = 'https://api-cost.pages.dev/api/sync';

    // æ—¥å¿—å‡½æ•°
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      const timestamp = new Date().toLocaleTimeString();
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function clearLog() {
      document.getElementById('log').innerHTML = '';
    }

    // è®¾å¤‡ ID ç”Ÿæˆ (æ¨¡æ‹Ÿ)
    async function generateDeviceId() {
      const stored = localStorage.getItem('_device_id');
      if (stored) return stored;

      const fingerprint = [
        navigator.userAgent,
        navigator.language,
        screen.width + 'x' + screen.height,
        new Date().getTimezoneOffset().toString(),
        navigator.hardwareConcurrency?.toString() || '0'
      ].join('|');

      const hashBuffer = await crypto.subtle.digest(
        'SHA-256',
        new TextEncoder().encode(fingerprint)
      );

      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const deviceId = hashArray
        .map(b => b.toString(16).padStart(2, '0'))
        .join('')
        .substring(0, 32);

      localStorage.setItem('_device_id', deviceId);
      return deviceId;
    }

    async function getDeviceId() {
      return await generateDeviceId();
    }

    // UI æ“ä½œ
    async function copyDeviceId() {
      const deviceId = await getDeviceId();
      await navigator.clipboard.writeText(deviceId);
      log(`âœ… è®¾å¤‡ ID å·²å¤åˆ¶: ${deviceId}`);
      alert('è®¾å¤‡ ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿!');
    }

    function regenerateDeviceId() {
      localStorage.removeItem('_device_id');
      location.reload();
    }

    async function setCustomDeviceId() {
      const customId = document.getElementById('custom-device-id').value;
      if (!customId || customId.length < 8) {
        alert('è®¾å¤‡ ID è‡³å°‘éœ€è¦ 8 ä¸ªå­—ç¬¦');
        return;
      }
      localStorage.setItem('_device_id', customId);
      log(`âœ… å·²è®¾ç½®è‡ªå®šä¹‰è®¾å¤‡ ID: ${customId}`);
      location.reload();
    }

    // äº‘ç«¯åŒæ­¥æµ‹è¯•
    async function uploadTest() {
      try {
        const deviceId = await getDeviceId();
        const data = JSON.parse(document.getElementById('test-data').value);

        log(`â¬†ï¸ å¼€å§‹ä¸Šä¼ ...`, 'info');
        log(`è®¾å¤‡ ID: ${deviceId}`, 'info');

        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Device-ID': deviceId
          },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Upload failed');
        }

        const result = await response.json();
        log(`âœ… ä¸Šä¼ æˆåŠŸ!`, 'success');
        log(`æ—¶é—´æˆ³: ${result.timestamp}`, 'info');
        log(`KV Key: user:${deviceId}`, 'info');

      } catch (error) {
        log(`âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function downloadTest() {
      try {
        const deviceId = await getDeviceId();

        log(`â¬‡ï¸ å¼€å§‹ä¸‹è½½...`, 'info');
        log(`è®¾å¤‡ ID: ${deviceId}`, 'info');

        const response = await fetch(API_ENDPOINT, {
          method: 'GET',
          headers: {
            'X-Device-ID': deviceId
          }
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Download failed');
        }

        const data = await response.json();
        log(`âœ… ä¸‹è½½æˆåŠŸ!`, 'success');
        log(`æ•°æ®å†…å®¹:`, 'info');
        log(JSON.stringify(data, null, 2), 'info');

        document.getElementById('test-data').value = JSON.stringify(data, null, 2);

      } catch (error) {
        log(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function clearTest() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤äº‘ç«¯æ•°æ®å—?')) return;

      try {
        const deviceId = await getDeviceId();

        log(`ğŸ—‘ï¸ å¼€å§‹æ¸…é™¤...`, 'info');

        const response = await fetch(API_ENDPOINT, {
          method: 'DELETE',
          headers: {
            'X-Device-ID': deviceId
          }
        });

        if (!response.ok) {
          throw new Error('Clear failed');
        }

        const result = await response.json();
        log(`âœ… æ¸…é™¤æˆåŠŸ!`, 'success');

      } catch (error) {
        log(`âŒ æ¸…é™¤å¤±è´¥: ${error.message}`, 'error');
        console.error(error);
      }
    }

    async function checkKVStorage() {
      const deviceId = await getDeviceId();
      log(`ğŸ“¦ KV å­˜å‚¨ä¿¡æ¯:`, 'info');
      log(`Key: user:${deviceId}`, 'info');
      log(`æç¤º: åœ¨ Cloudflare Dashboard -> KV ä¸­æŸ¥çœ‹æ­¤ Key`, 'info');
    }

    // åˆå§‹åŒ–
    (async function init() {
      const deviceId = await getDeviceId();
      document.getElementById('device-id').textContent = deviceId;
      log(`ğŸš€ æµ‹è¯•å·¥å…·å·²åŠ è½½`, 'success');
      log(`å½“å‰è®¾å¤‡ ID: ${deviceId}`, 'info');
    })();
  </script>
</body>
</html>
